<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchflow - Analyze GitHub PRs</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 2rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: #a1a1aa;
            font-size: 1.1rem;
        }
        .card {
            background: rgba(39, 39, 42, 0.8);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #d4d4d8;
        }
        .hint {
            font-size: 0.85rem;
            color: #71717a;
            margin-top: 0.25rem;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            background: #18181b;
            color: #fafafa;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        textarea {
            min-height: 200px;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #3f3f46;
            color: #fafafa;
        }
        .btn-secondary:hover {
            background: #52525b;
        }
        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .result {
            display: none;
        }
        .result.show {
            display: block;
        }
        .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .status-violations {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        .meta-info {
            display: flex;
            gap: 1.5rem;
            color: #a1a1aa;
            font-size: 0.9rem;
        }
        .violations-list {
            margin-top: 1rem;
        }
        .violation-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }
        .violation-item.medium {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }
        .violation-item.low {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
        }
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .violation-title {
            font-weight: 600;
            color: #fafafa;
        }
        .violation-severity {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .severity-high { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .severity-medium { background: rgba(245, 158, 11, 0.3); color: #fcd34d; }
        .severity-low { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        .severity-critical { background: rgba(220, 38, 38, 0.3); color: #f87171; }
        .violation-message {
            color: #d4d4d8;
            margin-bottom: 0.5rem;
        }
        .violation-fix {
            color: #a1a1aa;
            font-size: 0.9rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-top: 0.5rem;
        }
        .violation-fix::before {
            content: "üí° How to fix: ";
            color: #6366f1;
            font-weight: 500;
        }
        .repo-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .repo-info a {
            color: #818cf8;
            text-decoration: none;
        }
        .repo-info a:hover {
            text-decoration: underline;
        }
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
        }
        .loading.show {
            display: flex;
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #3f3f46;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #fca5a5;
        }
        .toggle-link {
            color: #818cf8;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .toggle-link:hover {
            text-decoration: underline;
        }
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible.open {
            max-height: 500px;
        }
        .pr-link {
            color: #818cf8;
            text-decoration: none;
        }
        .pr-link:hover {
            text-decoration: underline;
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #3f3f46;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Watchflow Analyzer</h1>
            <p class="subtitle">AI-Powered GitHub Governance: Analyze PRs, Generate Rules, and Convert Natural Language to YAML</p>
        </header>

        <!-- PR Analysis Card -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; color: #f8fafc;">üîç PR Analysis</h2>
            <form id="analyzeForm">
                <div class="form-group">
                    <label for="repoUrl">GitHub Repository / PR URL</label>
                    <input 
                        type="text" 
                        id="repoUrl" 
                        name="repoUrl"
                        placeholder="https://github.com/owner/repo/pull/123"
                        required
                    >
                    <p class="hint">Enter a GitHub PR URL (e.g., https://github.com/owner/repo/pull/123) or just owner/repo format</p>
                </div>

                <div class="form-group">
                    <label for="prNumber">PR Number (optional if included in URL)</label>
                    <input 
                        type="number" 
                        id="prNumber" 
                        name="prNumber"
                        placeholder="123"
                        min="1"
                    >
                    <p class="hint">Override PR number if not in URL</p>
                </div>

                <div class="form-group">
                    <span class="toggle-link" onclick="toggleOptional()">+ Advanced Options (Custom Rules, Token)</span>
                    <div id="optionalFields" class="collapsible">
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="rulesYaml">Custom Rules (YAML)</label>
                            <textarea 
                                id="rulesYaml" 
                                name="rulesYaml"
                                placeholder="rules:
  - description: &quot;PRs must have descriptive titles&quot;
    enabled: true
    severity: medium
    event_types: [pull_request]
    parameters:
      title_pattern: &quot;^feat|^fix|^docs&quot;"
                            ></textarea>
                            <p class="hint">Leave empty to use .watchflow/rules.yaml from the repository</p>
                        </div>

                        <div class="form-group">
                            <label for="githubToken">GitHub Personal Access Token (optional)</label>
                            <input 
                                type="text" 
                                id="githubToken" 
                                name="githubToken"
                                placeholder="ghp_xxxx"
                            >
                            <p class="hint">Required for private repositories. Token is not stored.</p>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                        </svg>
                        Analyze PR
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="loadSampleRules()">
                        Load Sample Rules
                    </button>
                </div>
            </form>
        </div>

        <!-- Natural Language Rule Conversion Card -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; color: #f8fafc;">üí≠ Natural Language Rule Converter</h2>
            <p class="hint" style="margin-bottom: 1rem;">Describe your rule in plain English and AI will convert it to Watchflow YAML format</p>
            
            <div class="form-group">
                <label for="ruleDescription">Rule Description (Natural Language)</label>
                <textarea 
                    id="ruleDescription" 
                    placeholder="Examples:
- PRs must reference an issue number (e.g., Fixes #123)
- Pull request titles should follow conventional commits
- Changes to Docker files require reviewer approval
- No direct commits to main branch
- Maximum 500 lines changed per PR"
                    style="min-height: 100px;"
                ></textarea>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-primary" onclick="convertRuleToYAML()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                    </svg>
                    Convert to YAML
                </button>
                <button type="button" class="btn btn-secondary" onclick="loadRuleExamples()">
                    Load Examples
                </button>
            </div>

            <div id="ruleConversionResult" style="display: none; margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem; color: #f8fafc;">Generated YAML:</h4>
                <pre id="generatedYAML" style="background: #1e293b; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.9rem; margin-bottom: 1rem;"></pre>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="copyToClipboard('generatedYAML')">
                        üìã Copy to Clipboard
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="insertIntoRulesEditor()">
                        üìù Insert into Rules Editor
                    </button>
                </div>
            </div>
        </div>

        <!-- Automatic Rule Generation Card -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; color: #f8fafc;">ü§ñ Automatic Rule Generation</h2>
            <p class="hint" style="margin-bottom: 1rem;">Analyze your repository's history and AI will generate tailored governance rules based on your team's patterns</p>
            
            <div class="form-group">
                <label for="genRepoUrl">GitHub Repository URL</label>
                <input 
                    type="text" 
                    id="genRepoUrl" 
                    placeholder="https://github.com/owner/repo"
                    required
                >
                <p class="hint">Public repository URL for analysis (supports private repos with token)</p>
            </div>

            <div class="form-group">
                <label for="githubTokenGen">GitHub Personal Access Token (optional)</label>
                <input 
                    type="text" 
                    id="githubTokenGen" 
                    placeholder="ghp_xxxx (for private repos)"
                >
                <p class="hint">Required only for private repositories</p>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-primary" onclick="generateRules()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Generate Rules
                </button>
            </div>

            <div id="ruleGenerationResult" style="display: none; margin-top: 1rem;">
                <h4 style="margin-bottom: 0.5rem; color: #f8fafc;">Generated Rules:</h4>
                <pre id="generatedRules" style="background: #1e293b; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.9rem; margin-bottom: 1rem;"></pre>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="copyToClipboard('generatedRules')">
                        üìã Copy to Clipboard
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="insertIntoRulesEditor()">
                        üìù Insert into Rules Editor
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createPRWithRules()">
                        üöÄ Create PR with Rules
                    </button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <span>Analyzing pull request...</span>
        </div>

        <div id="result" class="result card">
            <div class="result-header">
                <h2>Analysis Results</h2>
                <span id="statusBadge" class="status-badge"></span>
            </div>
            <div class="meta-info">
                <span id="rulesLoaded"></span>
                <span id="processingTime"></span>
            </div>
            <div id="repoInfoDisplay" class="repo-info"></div>
            <div id="violationsContainer"></div>
        </div>

        <div id="errorResult" class="result card">
            <div class="error-box">
                <strong>Error:</strong> <span id="errorMessage"></span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        const form = document.getElementById('analyzeForm');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const errorResult = document.getElementById('errorResult');
        const submitBtn = document.getElementById('submitBtn');

        function toggleOptional() {
            const optionalFields = document.getElementById('optionalFields');
            optionalFields.classList.toggle('open');
        }

        function loadSampleRules() {
            const sampleRules = `rules:
  - description: "Pull requests must have descriptive titles following conventional commit format"
    enabled: true
    severity: "medium"
    event_types: ["pull_request"]
    parameters:
      title_pattern: "^feat|^fix|^docs|^style|^refactor|^test|^chore|^perf|^ci|^build|^revert"

  - description: "PRs must include a meaningful description"
    enabled: true
    severity: "medium"
    event_types: ["pull_request"]
    parameters:
      min_description_length: 20

  - description: "Changes to critical files require review from code owners"
    enabled: true
    severity: "high"
    event_types: ["pull_request"]
    parameters:
      require_code_owner_reviewers: true`;
            document.getElementById('rulesYaml').value = sampleRules;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const repoUrl = document.getElementById('repoUrl').value.trim();
            const prNumber = document.getElementById('prNumber').value || null;
            const rulesYaml = document.getElementById('rulesYaml').value.trim() || null;
            const githubToken = document.getElementById('githubToken').value.trim() || null;

            // Hide previous results
            result.classList.remove('show');
            errorResult.classList.remove('show');
            
            // Show loading
            loading.classList.add('show');
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/v1/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repository_url: repoUrl,
                        pr_number: prNumber ? parseInt(prNumber) : null,
                        rules_yaml: rulesYaml,
                        github_token: githubToken,
                    }),
                });

                const data = await response.json();
                
                // Hide loading
                loading.classList.remove('show');
                submitBtn.disabled = false;

                if (data.success) {
                    displayResults(data);
                } else {
                    displayError(data.error || 'Analysis failed');
                }
            } catch (error) {
                loading.classList.remove('show');
                submitBtn.disabled = false;
                displayError(error.message || 'Network error occurred');
            }
        });

        function displayResults(data) {
            result.classList.add('show');
            errorResult.classList.remove('show');

            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            if (data.violations_count === 0) {
                statusBadge.textContent = '‚úì Passed';
                statusBadge.className = 'status-badge status-success';
            } else {
                statusBadge.textContent = `${data.violations_count} Violation${data.violations_count > 1 ? 's' : ''}`;
                statusBadge.className = 'status-badge status-violations';
            }

            // Update meta info
            document.getElementById('rulesLoaded').textContent = `üìã ${data.rules_loaded} rules loaded`;
            document.getElementById('processingTime').textContent = `‚è±Ô∏è ${data.processing_time_ms}ms`;

            // Update repo info
            const repoInfo = document.getElementById('repoInfoDisplay');
            if (data.repository) {
                const prLink = data.pr_data ? 
                    `<a href="${data.repository.url}/pull/${data.pr_data.number}" target="_blank" class="pr-link">PR #${data.pr_data.number}</a>` : 
                    '';
                repoInfo.innerHTML = `
                    <span>üìÅ</span>
                    <a href="${data.repository.url}" target="_blank">${data.repository.full_name}</a>
                    ${prLink}
                    ${data.pr_data ? `<span style="color: #a1a1aa;">"${data.pr_data.title || 'No title'}"</span>` : ''}
                `;
            }

            // Display violations
            const violationsContainer = document.getElementById('violationsContainer');
            if (data.violations && data.violations.length > 0) {
                violationsContainer.innerHTML = '<div class="violations-list">' +
                    data.violations.map(v => `
                        <div class="violation-item ${v.severity?.toLowerCase() || 'medium'}">
                            <div class="violation-header">
                                <span class="violation-title">${escapeHtml(v.rule_description || 'Rule Violation')}</span>
                                <span class="violation-severity severity-${v.severity?.toLowerCase() || 'medium'}">${v.severity || 'Medium'}</span>
                            </div>
                            <div class="violation-message">${escapeHtml(v.message || '')}</div>
                            ${v.how_to_fix ? `<div class="violation-fix">${escapeHtml(v.how_to_fix)}</div>` : ''}
                        </div>
                    `).join('') +
                    '</div>';
            } else {
                violationsContainer.innerHTML = '<p style="color: #22c55e; text-align: center; padding: 1rem;">‚úì No violations found. The PR passes all rules.</p>';
            }
        }

        function displayError(message) {
            result.classList.remove('show');
            errorResult.classList.add('show');
            document.getElementById('errorMessage').textContent = message;
        }

        // Natural Language Rule Conversion Functions
        async function convertRuleToYAML() {
            const ruleDescription = document.getElementById('ruleDescription').value.trim();
            if (!ruleDescription) {
                alert('Please enter a rule description');
                return;
            }

            showLoading('ruleConversionResult');
            
            try {
                // Use test endpoint for demo purposes
                const response = await fetch(`${API_BASE}/api/v1/rules/evaluate-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rule_text: ruleDescription,
                    }),
                });

                const data = await response.json();
                
                hideLoading('ruleConversionResult');
                
                if (data.success && data.data.supported) {
                    document.getElementById('generatedYAML').textContent = data.data.rule_yaml || data.data.snippet;
                    document.getElementById('ruleConversionResult').style.display = 'block';
                    showNotification('success', 'Rule converted to YAML successfully!');
                } else {
                    showNotification('error', `Rule not supported: ${data.message || 'This rule cannot be implemented with current Watchflow validators.'}`);
                }
            } catch (error) {
                hideLoading('ruleConversionResult');
                showNotification('error', `Failed to convert rule: ${error.message}`);
            }
        }

        function loadRuleExamples() {
            const examples = [
                "PRs must reference an issue number (e.g., Fixes #123)",
                "Pull request titles should follow conventional commits",
                "Changes to Docker files require reviewer approval", 
                "No direct commits to main branch",
                "Maximum 500 lines changed per PR",
                "PRs must have at least 2 approvals",
                "Changes to package.json require CODEOWNER review"
            ];
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('ruleDescription').value = randomExample;
        }

        // Automatic Rule Generation Functions
        async function generateRules() {
            const repoUrl = document.getElementById('genRepoUrl').value.trim();
            const githubToken = document.getElementById('githubTokenGen').value.trim() || null;
            
            if (!repoUrl) {
                alert('Please enter a repository URL');
                return;
            }

            showLoading('ruleGenerationResult');
            
            try {
                // Use test endpoint for demo purposes
                const response = await fetch(`${API_BASE}/api/v1/rules/recommend-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repo_url: repoUrl,
                        github_token: githubToken,
                    }),
                });

                const data = await response.json();
                
                hideLoading('ruleGenerationResult');
                
                if (data.success) {
                    document.getElementById('generatedRules').textContent = JSON.stringify(data.rules, null, 2);
                    document.getElementById('ruleGenerationResult').style.display = 'block';
                    showNotification('success', 'Rules generated successfully!');
                } else {
                    showNotification('error', `Failed to generate rules: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                hideLoading('ruleGenerationResult');
                showNotification('error', `Failed to generate rules: ${error.message}`);
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('success', 'Copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('success', 'Copied to clipboard!');
            });
        }

        function insertIntoRulesEditor() {
            const generatedElement = document.getElementById('generatedYAML') || document.getElementById('generatedRules');
            const yamlText = generatedElement.textContent;
            const rulesEditor = document.getElementById('rulesYaml');
            
            if (rulesEditor) {
                if (rulesEditor.value.trim()) {
                    if (confirm('This will replace the existing rules in the editor. Continue?')) {
                        rulesEditor.value = yamlText;
                    }
                } else {
                    rulesEditor.value = yamlText;
                }
                showNotification('success', 'Rules inserted into editor!');
            }
        }

        async function createPRWithRules() {
            const repoUrl = document.getElementById('genRepoUrl').value.trim();
            const githubToken = document.getElementById('githubTokenGen').value.trim() || null;
            
            if (!repoUrl) {
                alert('Please enter a repository URL');
                return;
            }

            showLoading('ruleGenerationResult');
            
            try {
                // Use test endpoint for demo purposes
                const response = await fetch(`${API_BASE}/api/v1/rules/recommend-test-proceed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        repo_url: repoUrl,
                        github_token: githubToken,
                    }),
                });

                const data = await response.json();
                
                hideLoading('ruleGenerationResult');
                
                if (data.pull_request_url) {
                    showNotification('success', `PR created successfully! View PR: ${data.pull_request_url}`);
                } else {
                    showNotification('error', `Failed to create PR: Unknown error`);
                }
            } catch (error) {
                hideLoading('ruleGenerationResult');
                showNotification('error', `Failed to create PR: ${error.message}`);
            }
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
                element.innerHTML = '<div class="loading"><div class="spinner"></div><span>Processing...</span></div>';
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        function showNotification(type, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
            `;
            
            if (type === 'success') {
                notification.style.background = 'rgba(34, 197, 94, 0.9)';
            } else {
                notification.style.background = 'rgba(239, 68, 68, 0.9)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-parse URL for PR number
        document.getElementById('repoUrl').addEventListener('input', (e) => {
            const url = e.target.value;
            const prMatch = url.match(/\/pull\/(\d+)/);
            if (prMatch && !document.getElementById('prNumber').value) {
                document.getElementById('prNumber').value = prMatch[1];
            }
        });
    </script>
</body>
</html>
